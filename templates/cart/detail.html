{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - {{ store.name|default:"xCommerce" }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="container mx-auto px-4">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Shopping Cart</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">
                {% if cart.total_items %}
                    {{ cart.total_items }} item{{ cart.total_items|pluralize }} in your cart
                {% else %}
                    Your cart is empty
                {% endif %}
            </p>
        </div>

        {% if cart.is_empty %}
            <!-- Empty Cart -->
            <div class="text-center py-16">
                <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-2">Your cart is empty</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Start shopping to add items to your cart.</p>
                <a href="{% url 'products:catalog' %}" class="btn-primary inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
                    </svg>
                    Continue Shopping
                </a>
            </div>
        {% else %}
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Cart Items -->
                <div class="lg:col-span-2">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border dark:border-gray-700">
                        <div class="p-6 border-b dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Cart Items</h2>
                                <button 
                                    onclick="clearCart()" 
                                    class="text-red-600 hover:text-red-700 text-sm font-medium"
                                >
                                    Clear Cart
                                </button>
                            </div>
                        </div>
                        
                        <div id="cart-items" class="divide-y dark:divide-gray-700">
                            {% for item in cart_items %}
                                <div class="p-6 cart-item" data-item-id="{{ item.id }}">
                                    <div class="flex items-start space-x-4">
                                        <!-- Product Image -->
                                        <div class="flex-shrink-0">
                                            {% if item.product.images.first %}
                                                <img src="{{ item.product.images.first.image.url }}" 
                                                     alt="{{ item.product.name }}"
                                                     class="w-20 h-20 object-cover rounded-lg">
                                            {% else %}
                                                <div class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                    </svg>
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Product Details -->
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                                                <a href="{% url 'products:detail' item.product.slug %}" 
                                                   class="hover:text-blue-600 dark:hover:text-blue-400">
                                                    {{ item.product.name }}
                                                </a>
                                            </h3>
                                            
                                            {% if item.variant %}
                                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                                    {{ item.variant.name }}
                                                </p>
                                            {% endif %}
                                            
                                            <div class="flex items-center justify-between mt-4">
                                                <!-- Quantity Controls -->
                                                <div class="flex items-center space-x-3">
                                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Qty:</label>
                                                    <div class="flex items-center border dark:border-gray-600 rounded-md">
                                                        <button 
                                                            onclick="updateQuantity({{ item.id }}, {{ item.quantity|add:'-1' }})"
                                                            class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-l-md"
                                                            {% if item.quantity <= 1 %}disabled{% endif %}
                                                        >
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                                            </svg>
                                                        </button>
                                                        <input 
                                                            type="number" 
                                                            value="{{ item.quantity }}" 
                                                            min="1" 
                                                            class="w-16 text-center py-1 border-0 focus:ring-0 bg-transparent dark:text-white"
                                                            onchange="updateQuantity({{ item.id }}, this.value)"
                                                        >
                                                        <button 
                                                            onclick="updateQuantity({{ item.id }}, {{ item.quantity|add:'1' }})"
                                                            class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-r-md"
                                                        >
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Price and Remove -->
                                                <div class="text-right">
                                                    <p class="text-lg font-semibold text-gray-900 dark:text-white item-total">
                                                        ${{ item.total_price }}
                                                    </p>
                                                    {% if item.quantity > 1 %}
                                                        <p class="text-sm text-gray-600 dark:text-gray-400">
                                                            ${{ item.unit_price }} each
                                                        </p>
                                                    {% endif %}
                                                    <button 
                                                        onclick="removeFromCart({{ item.id }})"
                                                        class="text-red-600 hover:text-red-700 text-sm mt-2"
                                                    >
                                                        Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border dark:border-gray-700 sticky top-6">
                        <div class="p-6">
                            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Order Summary</h2>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Subtotal</span>
                                    <span class="font-medium dark:text-white" id="cart-subtotal">${{ subtotal }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Shipping</span>
                                    <span class="font-medium dark:text-white">${{ shipping_cost }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Tax ({{ tax_rate|floatformat:0 }}%)</span>
                                    <span class="font-medium dark:text-white">${{ tax_amount|floatformat:2 }}</span>
                                </div>
                                <hr class="dark:border-gray-700">
                                <div class="flex justify-between text-lg font-semibold">
                                    <span class="text-gray-900 dark:text-white">Total</span>
                                    <span class="text-gray-900 dark:text-white" id="cart-total">${{ total|floatformat:2 }}</span>
                                </div>
                            </div>
                            
                            <div class="mt-6 space-y-3">
                                <a href="{% url 'cart:checkout' %}" class="btn-primary w-full justify-center">
                                    Proceed to Checkout
                                </a>
                                <a href="{% url 'products:catalog' %}" class="btn-secondary w-full justify-center">
                                    Continue Shopping
                                </a>
                            </div>
                            
                            <!-- Security Trust Badges -->
                            <div class="mt-6 pt-6 border-t dark:border-gray-700">
                                <div class="flex items-center justify-center space-x-4 text-sm text-gray-600 dark:text-gray-400">
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        Secure
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        SSL Protected
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
// CSRF Token
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Show toast notification
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    toast.textContent = message;
    
    document.getElementById('toast-container').appendChild(toast);
    
    // Animate in
    setTimeout(() => toast.classList.remove('translate-x-full'), 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Update quantity
async function updateQuantity(itemId, quantity) {
    if (quantity < 1) return;
    
    try {
        const response = await fetch('{% url "cart:update" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity: parseInt(quantity)
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update item total
            const itemElement = document.querySelector(`[data-item-id="${itemId}"] .item-total`);
            itemElement.textContent = `$${data.item_total}`;
            
            // Update cart totals
            updateCartTotals(data.cart_subtotal);
            
            // Update quantity input
            const quantityInput = document.querySelector(`[data-item-id="${itemId}"] input[type="number"]`);
            quantityInput.value = quantity;
            
            showToast('Cart updated');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('Error updating cart', 'error');
    }
}

// Remove from cart
async function removeFromCart(itemId) {
    if (!confirm('Are you sure you want to remove this item?')) return;
    
    try {
        const response = await fetch('{% url "cart:remove" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                item_id: itemId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove item from DOM
            document.querySelector(`[data-item-id="${itemId}"]`).remove();
            
            // Update cart totals
            updateCartTotals(data.cart_subtotal);
            
            // Check if cart is empty
            if (data.cart_count === 0) {
                location.reload();
            }
            
            showToast(data.message);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('Error removing item', 'error');
    }
}

// Clear cart
async function clearCart() {
    if (!confirm('Are you sure you want to clear your entire cart?')) return;
    
    try {
        const response = await fetch('{% url "cart:clear" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('Error clearing cart', 'error');
    }
}

// Update cart totals (simplified - would need backend calculation for tax)
function updateCartTotals(subtotal) {
    document.getElementById('cart-subtotal').textContent = `$${subtotal}`;
    // Note: In a real app, you'd recalculate tax and total on the backend
}

// Update header cart count
function updateHeaderCartCount(count) {
    const cartCountElements = document.querySelectorAll('.cart-count');
    cartCountElements.forEach(element => {
        element.textContent = count;
        element.style.display = count > 0 ? 'block' : 'none';
    });
}
</script>
{% endblock %}